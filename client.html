<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
		<!-- extract:style.html -->
		<style>
			html, body {
				font-family: Arial;
				font-size: 14px;
				background: #fff;
				padding: 3px;
				color: #000;
				margin: 0;
				width: 100%;
				line-height: 2em;
				box-sizing: border-box;
			}
			section {
				width: 350px;
				margin: 0 auto;
			}
			fieldset>legend {
				font-weight: bolder;
			}
			label>span,
			div>span {
				display: inline-block;
				margin-right: 2px;
			}
			div.h {
				margin-left: 22px;
			}
			div>span {
				width: 52px;
				text-align: center;
			}
			label>span {
				width: 50px;
				height: 25px;
				border: 1px solid black;
				vertical-align: bottom;
			}
			header, footer {
				text-align: center;
			}
			footer {
				color: #888;
				font-size: 0.75rem;
			}
			#l a {
				margin-left:5px;
			}
		</style>
		<!-- endextract -->
	</head>
	<body>
		<!-- extract:body.html -->
		<header>
			<h1>WiFibonacci Clock Settings</h1>
		</header>
		<section>
			<form>
				<fieldset>
					<legend>General</legend>
					<input type="radio" name="m" id="m0" onclick="zm(this)" value="0"><label for="m0">Clock</label><br>
					<input type="radio" name="m" id="m1" onclick="zm(this)" value="1"><label for="m1">Rainbow Cycle</label><br>
					<input type="radio" name="m" id="m2" onclick="zm(this)" value="2"><label for="m2">Rainbow</label><br>
					<input type="radio" name="m" id="m3" onclick="zm(this)" value="3"><label for="m3">Pulse</label><br>
					<input type="radio" name="m" id="m4" onclick="zm(this)" value="4"><label for="m4">Constant Light</label><br>
					Brightness: <input name="b" type="range" min="1" max="255" oninput="y(this,c,'b')"> <input type="number" name="c" min="1" max="255" oninput="y(this,b,'b')">
				</fieldset>
				<fieldset>
					<legend>Clock</legend>
					Date and time:<br>
					<input type="datetime-local" name="t" oninput="z(this,'t')"> <input type="button" onclick="x(t)" value="now"><br>
					Palettes:<br>
					<div class="h"><span>off</span><span>hours</span><span>minutes</span><span>both</span></div>
					<div id="l"></div>
					Upload palette:<br>
					<input type="file" name="i"> <input type="button" onclick="q(i)" value="upload">
				</fieldset>
				<fieldset>
					<legend>Rainbow</legend>
					Delay (ms): <input name="r" type="range" min="1" max="100" oninput="y(this,s,'r')"> <input type="number" name="s" min="1" max="100" oninput="y(this,r,'r')">
				</fieldset>
				<fieldset>
					<legend>Pulse</legend>
					Color: <input name="p" type="color" oninput="z(this,'p')"><br>
					Delay (ms): <input name="d" type="range" min="1" max="100" oninput="y(this,e,'p')"> <input type="number" name="e" min="1" max="100" oninput="y(this,d,'p')">
				</fieldset>
				<fieldset>
					<legend>Constant light</legend>
					Color: <input name="f" type="color" oninput="z(this,'f')">
				</fieldset>
			</form>
		</section>
		<footer>
			&copy; 2017 Cl√©ment Ronzon
		</footer>
		<!-- endextract -->
		<script>
			/* extract:script.js */
			// Keep in mind that anything defined inside this extracted section will live in the scope of _w.onmessage function. Remember to publish whatever needs to be published.
			window.m = function(i) {
				_f.l[i].checked = 1;
			};
			window.n = function(a) {
				var li = a.parentNode,
					i = 0;
				while (li.previousElementSibling) {
					li = li.previousElementSibling;
					i ++;
				}
				return w(i);
			};
			window.o = function(arr) {
				var rand = Math.random(),
					html = '<div><input type="radio" name="l" id="l' + rand + '" onclick="zl(this)"><label for="l' + rand + '">';
				for (var i = 0; i < 4; i++) html += '<span style="background-color:#' + arr[i] + '"></span>';
				html += arr[4] + '</label>';
				if (_f.l) html += '<a href="#" onclick="zd(this)">X</a>';
				html += '</div>';
				t(s('#l'), html);
				if (!_f.l.value) m(0);
			};
			window.p = function() {
				alert('Failure');
			};
			window.q = function(input) {
				var file = input.files[0],
					fr = new FileReader();
				fr.onerror = p;
				fr.onload = function(e) {
					_c = e.target.result;
					_a = file.name;
					zz(_a, 'a');
					zz(_c, 'c');
				};
				fr.readAsText(file);
			};
			window.u = function(input) {
				var val = input.value * 1;
				return val === '' || input.min && val < input.min * 1 || input.max && val > input.max * 1;
			};
			window.v = function(val) {
				return (val < 100 ? '0' : '') + val;
			};
			window.w = function(val) {
				return (val < 10 ? '0' : '') + val;
			};
			window.x = function(input) {
				var date = new Date(),
					hours = w(date.getHours()),
					minutes = w(date.getMinutes()),
					seconds = w(date.getSeconds()),
					year = date.getFullYear(),
					month = date.getMonth(),
					day = w(date.getDate());
				input.value = year + '-' + w(month + 1) + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds; //2009-02-06T01:04:05
				zz(['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][month] + ' ' + day + ' ' + year + hours + ':' + minutes + ':' + seconds, 't'); //Feb 06 200901:04:05
			};
			window.y = function(input1, input2, code) {
				if (u(input1)) return;
				var val = input1.value;
				input2.value = val;
				zz(v(w(val)), code);
			};
			window.z = function(input, code) {
				if (u(input)) return;
				var val = input.value;
				console.log(code + val);
				_w.send(code + val);
			};
			window.zz = function(val, code) {
				z({value: val}, code);
			};
			window.zl = function(input) {
				zz(n(input), 'l');
			};
			window.zd = function(a) {
				zz(n(a), 'd');
				a.parentNode.remove();
				if (!_f.l.value) _f.l[0].click();
			};
			window.zm = function(input) {
				z(input, 'm');
			};
			/* endextract */
			function s(selector) {
				return document.querySelector(selector);
			}
			function t(container, html) {
				var d = document.createElement('div');
				d.innerHTML = html;
				while (d.children.length > 0) container.appendChild(d.children[0]);
			}
			var _a, _c, _f,
				_w = new WebSocket('ws://192.168.4.1:81/', ['arduino']);
			_w.onmessage = function (e) {
				var data = e.data;
				if (_c) {
					if (data == 'o') {
						_c = JSON.parse(_c);
						_c.push(_a.split('.')[0]);
						o(_c);
						_f.i.value = '';
					} else {
						p();
					}
					_c = 0;
				}
				switch (data[0]) {
					case '{':
					case '[':
						var json = JSON.parse(data);
						if (typeof json.mode != 'undefined') {
							_f.m.value = json.mode;
							_f.b.value = json.brightness;
							_f.c.value = _f.b.value;
							_f.t.value = json.dateTime;
							_f.f.value = '#' + json.flashLightColor;
							_f.p.value = '#' + json.pulse.color;
							_f.d.value = json.pulse.delay;
							_f.e.value = _f.d.value;
							_f.r.value = json.rainbowDelay;
							_f.s.value = _f.r.value;
							m(json.palette);
						} else { //["ffffff", "ffffff", "ffffff", "ffffff"]
							o(json);
						}
						break;
					case '<':
						t(s(data.indexOf('<style>') == 0 ? 'head' : 'body'), data);
						_f = s('form');
						break;
					default:
						eval(data);
				}
			};
		</script>
	</body>
</html>